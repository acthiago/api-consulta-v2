# ===== API Consulta v2 - Makefile =====
.PHONY: help install dev test lint format docker-dev: ## ðŸš€ Run development environment
	@echo "$(GREEN)ðŸš€ Starting development environment...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.dev.yml up -d
	@echo "$(GREEN)âœ… Development environment running at http://localhost:8000$(RESET)"

docker-prod: ## ðŸ­ Run production environment
	@echo "$(GREEN)ðŸ­ Starting production environment...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.prod.yml up -d
	@echo "$(GREEN)âœ… Production environment running at http://localhost:8000$(RESET)"

docker-stop: ## â¹ï¸  Stop all Docker services
	@echo "$(YELLOW)â¹ï¸  Stopping all Docker services...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.dev.yml down || true
	$(DOCKER_COMPOSE) -f docker-compose.prod.yml down || true
	$(DOCKER_COMPOSE) down || true

docker-logs: ## ðŸ“„ Show Docker logs
	@echo "$(GREEN)ðŸ“„ Showing Docker logs...$(RESET)"
	$(DOCKER_COMPOSE) logs -fclean docker-build docker-run docker-stop

# Colors for output
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# Variables
PYTHON := python3
PIP := pip3
DOCKER_IMAGE := poc-api-consulta-v2
DOCKER_TAG := latest

# Docker Compose command detection (supports both old and new syntax)
DOCKER_COMPOSE := $(shell if command -v docker-compose >/dev/null 2>&1; then echo "docker-compose"; else echo "docker compose"; fi)

help: ## ðŸ“‹ Show this help message
	@echo "$(GREEN)ðŸš€ API Consulta v2 - Available Commands$(RESET)"
	@echo "$(YELLOW)Using Docker Compose: $(DOCKER_COMPOSE)$(RESET)"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage: make $(YELLOW)<target>$(RESET)\n\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(GREEN)%-20s$(RESET) %s\n", $$1, $$2 } /^##@/ { printf "\n$(YELLOW)%s$(RESET)\n", substr($$0, 5) }' $(MAKEFILE_LIST)

##@ ðŸ› ï¸  Development
install: ## ðŸ“¦ Install dependencies
	@echo "$(GREEN)ðŸ“¦ Installing dependencies...$(RESET)"
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	$(PIP) install pytest pytest-cov pytest-asyncio black isort flake8 mypy safety bandit

dev: ## ðŸš€ Start development environment
	@echo "$(GREEN)ðŸš€ Starting development environment...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.dev.yml up -d

dev-logs: ## ðŸ“„ Show development logs
	@echo "$(GREEN)ðŸ“„ Showing development logs...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.dev.yml logs -f

dev-stop: ## â¹ï¸  Stop development environment
	@echo "$(YELLOW)â¹ï¸  Stopping development environment...$(RESET)"
	$(DOCKER_COMPOSE) -f docker-compose.dev.yml down

##@ ðŸ§ª Testing & Quality
test: ## ðŸ§ª Run tests
	@echo "$(GREEN)ðŸ§ª Running tests...$(RESET)"
	$(PYTHON) -m pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=html

test-unit: ## ðŸŽ¯ Run unit tests only
	@echo "$(GREEN)ðŸŽ¯ Running unit tests...$(RESET)"
	$(PYTHON) -m pytest tests/unit/ -v

test-integration: ## ðŸ”— Run integration tests only
	@echo "$(GREEN)ðŸ”— Running integration tests...$(RESET)"
	$(PYTHON) -m pytest tests/integration/ -v

lint: ## ðŸ” Run linting checks
	@echo "$(GREEN)ðŸ” Running linting checks...$(RESET)"
	flake8 src/ tests/
	mypy src/ --ignore-missing-imports

format: ## âœ¨ Format code
	@echo "$(GREEN)âœ¨ Formatting code...$(RESET)"
	black src/ tests/
	isort src/ tests/

format-check: ## ðŸ“‹ Check code formatting
	@echo "$(GREEN)ðŸ“‹ Checking code formatting...$(RESET)"
	black --check --diff src/ tests/
	isort --check-only --diff src/ tests/

security: ## ðŸ”’ Run security checks
	@echo "$(GREEN)ðŸ”’ Running security checks...$(RESET)"
	safety check -r requirements.txt
	bandit -r src/ -f json -o bandit-report.json || true
	@echo "$(GREEN)ðŸ“Š Security report saved to bandit-report.json$(RESET)"

quality: format lint security test ## ðŸ† Run all quality checks

##@ ðŸ³ Docker
docker-build: ## ðŸ—ï¸  Build Docker image
	@echo "$(GREEN)ðŸ—ï¸  Building Docker image...$(RESET)"
	docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) .

docker-dev: ## ï¿½ Run development environment
	@echo "$(GREEN)ðŸš€ Starting development environment...$(RESET)"
	docker-compose -f docker-compose.dev.yml up -d
	@echo "$(GREEN)âœ… Development environment running at http://localhost:8000$(RESET)"

docker-prod: ## ðŸ­ Run production environment
	@echo "$(GREEN)ðŸ­ Starting production environment...$(RESET)"
	docker-compose -f docker-compose.prod.yml up -d
	@echo "$(GREEN)âœ… Production environment running at http://localhost:8000$(RESET)"

docker-stop: ## â¹ï¸  Stop all Docker services
	@echo "$(YELLOW)â¹ï¸  Stopping all Docker services...$(RESET)"
	docker-compose -f docker-compose.dev.yml down || true
	docker-compose -f docker-compose.prod.yml down || true
	docker-compose down || true

docker-logs: ## ðŸ“„ Show Docker logs
	@echo "$(GREEN)ðŸ“„ Showing Docker logs...$(RESET)"
	docker-compose logs -f

##@ ðŸš€ Production
build: ## ðŸ­ Production build
	@echo "$(GREEN)ðŸ­ Building for production...$(RESET)"
	docker build --target production -t $(DOCKER_IMAGE):prod .

run: ## â–¶ï¸  Run application locally
	@echo "$(GREEN)â–¶ï¸  Running application...$(RESET)"
	uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload

##@ ðŸ§¹ Cleanup
clean: ## ðŸ§¹ Clean up temporary files
	@echo "$(GREEN)ðŸ§¹ Cleaning up...$(RESET)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	find . -type f -name ".coverage" -delete
	find . -type d -name "htmlcov" -exec rm -rf {} +
	find . -type f -name "bandit-report.json" -delete

clean-docker: ## ðŸ³ Clean Docker resources
	@echo "$(GREEN)ðŸ³ Cleaning Docker resources...$(RESET)"
	docker system prune -f
	docker image prune -f
	docker volume prune -f

##@ ðŸ“Š Monitoring
monitor: ## ðŸ“Š Open monitoring dashboards
	@echo "$(GREEN)ðŸ“Š Opening monitoring dashboards...$(RESET)"
	@echo "Grafana: http://localhost:3000 (admin/admin123)"
	@echo "Prometheus: http://localhost:9090"

health: ## ðŸ” Check application health
	@echo "$(GREEN)ðŸ” Checking application health...$(RESET)"
	curl -f http://localhost:8000/health || echo "$(RED)âŒ Application is not healthy$(RESET)"

##@ ðŸ“š Documentation
docs: ## ðŸ“š Generate documentation
	@echo "$(GREEN)ðŸ“š Documentation available at:$(RESET)"
	@echo "API Docs: http://localhost:8000/docs"
	@echo "ReDoc: http://localhost:8000/redoc"
	@echo "API Reference: docs/API_REFERENCE.md"
	@echo "Architecture: docs/ARCHITECTURE.md"

##@ ðŸ”§ Utilities
check-requirements: ## ðŸ” Check system requirements
	@echo "$(GREEN)ðŸ” Checking system requirements...$(RESET)"
	@command -v docker >/dev/null 2>&1 || { echo "$(RED)âŒ Docker is not installed$(RESET)"; exit 1; }
	@echo "$(GREEN)âœ… Docker: $(shell docker --version)$(RESET)"
	@echo "$(GREEN)âœ… Docker Compose: $(DOCKER_COMPOSE)$(RESET)"
	@$(DOCKER_COMPOSE) version >/dev/null 2>&1 || { echo "$(RED)âŒ Docker Compose is not working$(RESET)"; exit 1; }
	@echo "$(GREEN)âœ… All requirements satisfied$(RESET)"

env-example: ## ðŸ“ Create .env example file
	@echo "$(GREEN)ðŸ“ Creating .env.example...$(RESET)"
	@echo "# Environment Configuration" > .env.example
	@echo "DEBUG=true" >> .env.example
	@echo "LOG_LEVEL=INFO" >> .env.example
	@echo "SECRET_KEY=your-secret-key-here" >> .env.example
	@echo "JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env.example
	@echo "JWT_REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env.example
	@echo "MONGO_URI=mongodb://localhost:27017" >> .env.example
	@echo "MONGO_DB_NAME=api_consulta_v2" >> .env.example
	@echo "REDIS_URL=redis://localhost:6379/0" >> .env.example
	@echo "CACHE_TTL_CLIENTE=1800" >> .env.example
	@echo "CACHE_TTL_PAGAMENTO=1800" >> .env.example
	@echo "CACHE_TTL_BOLETO=3600" >> .env.example
	@echo "$(GREEN)âœ… .env.example created$(RESET)"

init: install env-example ## ðŸŽ¯ Initialize project for development
	@echo "$(GREEN)ðŸŽ¯ Project initialized for development!$(RESET)"
	@echo "$(YELLOW)Next steps:$(RESET)"
	@echo "1. Copy .env.example to .env and configure"
	@echo "2. Run 'make dev' to start development environment"
	@echo "3. Run 'make test' to run tests"
